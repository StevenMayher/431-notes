% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{book}
\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{ifxetex,ifluatex}
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  pdftitle={Data Science for Biological, Medical and Health Research: Notes for PQHS/CRSP/MPHP 431},
  pdfauthor={Thomas E. Love},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\usepackage{booktabs}
\usepackage{amsthm}
\makeatletter
\def\thm@space@setup{%
  \thm@preskip=8pt plus 2pt minus 4pt
  \thm@postskip=\thm@preskip
}
\makeatother
\ifluatex
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage[]{natbib}
\bibliographystyle{apalike}

\title{Data Science for Biological, Medical and Health Research: Notes for PQHS/CRSP/MPHP 431}
\author{Thomas E. Love}
\date{2021-08-19}

\begin{document}
\maketitle

{
\setcounter{tocdepth}{1}
\tableofcontents
}
\hypertarget{working-with-these-notes}{%
\chapter*{Working with These Notes}\label{working-with-these-notes}}
\addcontentsline{toc}{chapter}{Working with These Notes}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  This document is broken down into multiple chapters. Use the table of contents on the left side of the screen to navigate, and use the hamburger icon (horizontal bars) at the top of the document to open or close the table of contents.
\item
  At the top of the document, you'll see additional icons which you can click to

  \begin{itemize}
  \tightlist
  \item
    search the document,
  \item
    change the size, font or color scheme of the page, and
  \item
    download a PDF or EPUB (Kindle-readable) version of the entire document.
  \end{itemize}
\item
  The document will be updated (unpredictably) throughout the semester.
\end{enumerate}

\hypertarget{the-431-course-online}{%
\section*{The 431 Course online}\label{the-431-course-online}}
\addcontentsline{toc}{section}{The 431 Course online}

The \textbf{main web page} for the 431 course in Fall 2021 is \url{https://thomaselove.github.io/431/}. Go there for all information related to the course.

\begin{center}\includegraphics[width=0.8\linewidth]{figures/431_foot2} \end{center}

\hypertarget{what-youll-find-here}{%
\section*{What You'll Find Here}\label{what-youll-find-here}}
\addcontentsline{toc}{section}{What You'll Find Here}

These Notes provide a series of examples using R to work through issues that are likely to come up in PQHS/CRSP/MPHP 431. What you will mostly find are brief explanations of a key idea or summary, accompanied (most of the time) by R code and a demonstration of the results of applying that code.

While these Notes share some of the features of a textbook, they are neither comprehensive nor completely original. The main purpose is to give 431 students a set of common materials on which to draw during the course. In class, we will sometimes:

\begin{itemize}
\tightlist
\item
  reiterate points made in this document,
\item
  amplify what is here,
\item
  simplify the presentation of things done here,
\item
  use new examples to show some of the same techniques,
\item
  refer to issues not mentioned in this document,
\end{itemize}

but what we don't do is follow these notes very precisely. We assume instead that you will read the materials and try to learn from them, just as you will attend classes and try to learn from them. We welcome feedback of all kinds on this document or anything else.

Everything you see here is available to you as HTML or PDF. You will also have access to the R Markdown files, which contain the code which generates everything in the document, including all of the R results. We will demonstrate the use of R Markdown (this document is generated with the additional help of an R package called \texttt{bookdown}) and RStudio (the ``program'' we use to interface with the R language) in class.

All data and R code related to these notes are also available to you.

\hypertarget{setting-up-r}{%
\section*{Setting Up R}\label{setting-up-r}}
\addcontentsline{toc}{section}{Setting Up R}

These Notes make extensive use of

\begin{itemize}
\tightlist
\item
  the statistical software language R, and
\item
  the development environment R Studio,
\end{itemize}

both of which are free, and you'll need to install them on your machine. Instructions for doing so are in found in the course syllabus.

If you need an even gentler introduction, or if you're just new to R and RStudio and need to learn about them, we encourage you to take a look at \url{http://moderndive.com/}, which provides an introduction to statistical and data sciences via R at \citet{ModernDive}.

These notes were written using R Markdown. R Markdown, like R and R Studio, is free and open source.

R Markdown is described as an \emph{authoring framework} for data science, which lets you

\begin{itemize}
\tightlist
\item
  save and execute R code
\item
  generate high-quality reports that can be shared with an audience
\end{itemize}

This description comes from \url{http://rmarkdown.rstudio.com/lesson-1.html} which you can visit to get an overview and quick tour of what's possible with R Markdown.

Another excellent resource to learn more about R Markdown tools is the Communicate section (especially the R Markdown chapter) of \citet{R4DS}.

\hypertarget{initial-setup-of-r-packages}{%
\section*{Initial Setup of R Packages}\label{initial-setup-of-r-packages}}
\addcontentsline{toc}{section}{Initial Setup of R Packages}

To start, I'll present a series of commands I run at the beginning of these Notes. These particular commands set up the output so it will look nice as either an HTML or PDF file, and also set up R to use several packages (libraries) of functions that expand its capabilities. A chunk of code like this will occur near the top of any R Markdown work.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{knitr}\SpecialCharTok{::}\NormalTok{opts\_chunk}\SpecialCharTok{$}\FunctionTok{set}\NormalTok{(}\AttributeTok{comment =} \ConstantTok{NA}\NormalTok{)}

\FunctionTok{library}\NormalTok{(knitr)}
\FunctionTok{library}\NormalTok{(magrittr)}
\FunctionTok{library}\NormalTok{(janitor)}
\FunctionTok{library}\NormalTok{(NHANES)}
\FunctionTok{library}\NormalTok{(palmerpenguins)}
\FunctionTok{library}\NormalTok{(patchwork)}
\FunctionTok{library}\NormalTok{(rms)}
\FunctionTok{library}\NormalTok{(mosaic)}
\FunctionTok{library}\NormalTok{(Epi)}
\FunctionTok{library}\NormalTok{(broom) }\CommentTok{\# note: tidymodels includes the broom package}
\FunctionTok{library}\NormalTok{(tidyverse) }\CommentTok{\# note: tidyverse includes the dplyr and ggplot2 packages}

\FunctionTok{theme\_set}\NormalTok{(}\FunctionTok{theme\_bw}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

I have deliberately set up this list of loaded packages to be relatively small, and will add some others later in these Notes. You only need to install a package once, but you need to reload it every time you start a new session.

\hypertarget{the-love-boost.r-script}{%
\section*{\texorpdfstring{The \texttt{Love-boost.R} script}{The Love-boost.R script}}\label{the-love-boost.r-script}}
\addcontentsline{toc}{section}{The \texttt{Love-boost.R} script}

Starting in October, we'll make use of a few scripts I've gathered for you.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{source}\NormalTok{(}\StringTok{"data/Love{-}boost.R"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{additional-r-packages-installed-for-this-book}{%
\section*{Additional R Packages installed for this book}\label{additional-r-packages-installed-for-this-book}}
\addcontentsline{toc}{section}{Additional R Packages installed for this book}

Some packages need to be installed on the user's system, but do not need to be loaded by R in order to run the code presented in this set of notes until later. These additional packages include the following.

\begin{verbatim}
boot
car
GGally
gt
psych
modelsummary
naniar
visdat
\end{verbatim}

\hypertarget{data-science}{%
\chapter{Data Science}\label{data-science}}

The definition of \textbf{data science} can be a little slippery. One current view of data science, is exemplified by Steven Geringer's 2014 Venn diagram.

\begin{figure}
\includegraphics[width=0.8\linewidth]{figures/data-science-venn20} \caption{Data Science Venn Diagram from Steven Geringer}\label{fig:datasci-fig}
\end{figure}

\begin{itemize}
\tightlist
\item
  The field encompasses ideas from mathematics and statistics and from computer science, but with a heavy reliance on subject-matter knowledge. In our case, this includes clinical, health-related, medical or biological knowledge.
\item
  As \citet{Gelman-Nolan} suggest, the experience and intuition necessary for good statistical practice are hard to obtain, and teaching data science provides an excellent opportunity to reinforce statistical thinking skills across the full cycle of a data analysis project.
\item
  The principal form in which computer science (coding/programming) play a role in this course is to provide a form of communication. You'll need to learn how to express your ideas not just orally and in writing, but also through your code.
\end{itemize}

Data Science is a \textbf{team} activity. Everyone working in data science brings some part of the necessary skillset, but no one person can cover all three areas alone for excellent projects.

\begin{quote}
{[}The individual who is truly expert in all three key areas (mathematics/statistics, computer science and subject-matter knowledge) is{]} a mythical beast with magical powers who's rumored to exist but is never actually seen in the wild.

\url{http://www.kdnuggets.com/2016/10/battle-data-science-venn-diagrams.html}
\end{quote}

\hypertarget{data-science-project-cycle}{%
\section{Data Science Project Cycle}\label{data-science-project-cycle}}

A typical data science project can be modeled as follows, which comes from the introduction to the amazing book \textbf{R for Data Science}, by Garrett Grolemund and Hadley Wickham, which is a key text for this course \citep{R4DS}.

\begin{figure}
\includegraphics[width=0.95\linewidth]{figures/data-science-cycle} \caption{Source: R for Data Science: Introduction}\label{fig:cycle-fig}
\end{figure}

This diagram is sometimes referred to as the Krebs Cycle of Data Science. For more on the steps of a data science project, we encourage you to read the Introduction of \citet{R4DS}.

\hypertarget{data-science-and-the-431-course}{%
\section{Data Science and the 431 Course}\label{data-science-and-the-431-course}}

We'll discuss each of these elements in the 431 course, focusing at the start on understanding our data through transformation, modeling and (especially in the early stages) visualization. In 431, we learn how to get things done.

\begin{itemize}
\tightlist
\item
  We get people working with R and R Studio and R Markdown, even if they are completely new to coding. A gentle introduction is provided at \citet{ModernDive}
\item
  We learn how to use the \texttt{tidyverse} (\url{http://www.tidyverse.org/}), an array of tools in R (mostly developed by Hadley Wickham and his colleagues at R Studio) which share an underlying philosophy to make data science faster, easier, more reproducible and more fun. A critical text for understanding the tidyverse is \citet{R4DS}. Tidyverse tools facilitate:

  \begin{itemize}
  \tightlist
  \item
    \textbf{importing} data into R, which can be the source of intense pain for some things, but is really quite easy 95\% of the time with the right tool.
  \item
    \textbf{tidying} data, that is, storing it in a format that includes one row per observation and one column per variable. This is harder, and more important, than you might think.
  \item
    \textbf{transforming} data, perhaps by identifying specific subgroups of interest, creating new variables based on existing ones, or calculating summaries.
  \item
    \textbf{visualizing} data to generate actual knowledge and identify questions about the data - this is an area where R really shines, and we'll start with it in class.
  \item
    \textbf{modeling} data, taking the approach that modeling is complementary to visualization, and allows us to answer questions that visualization helps us identify.
  \item
    and last, but definitely not least, \textbf{communicating} results, models and visualizations to others, in a way that is reproducible and effective.
  \end{itemize}
\item
  Some programming/coding is an inevitable requirement to accomplish all of these aims. If you are leery of coding, you'll need to get past that, with the help of this course and our stellar teaching assistants. Getting started is always the most challenging part, but our experience is that most of the pain of developing these new skills evaporates by early October.
\end{itemize}

\hypertarget{what-the-course-is-and-isnt}{%
\section{What The Course Is and Isn't}\label{what-the-course-is-and-isnt}}

The 431 course is about \textbf{getting things done}. In developing this course, we adopt a modern approach that places data at the center of our work. Our goal is to teach you how to do truly reproducible research with modern tools. We want you to be able to collect and use data effectively to address questions of interest.

The curriculum includes more on several topics than you might expect from a standard graduate introduction to biostatistics.

\begin{itemize}
\tightlist
\item
  data gathering
\item
  data wrangling
\item
  exploratory data analysis and visualization
\item
  multivariate modeling
\item
  communication
\end{itemize}

It also nearly completely avoids formalism and is extremely applied - this is absolutely \textbf{not} a course in theoretical or mathematical statistics, and these Notes reflect that approach.

There's very little of the mathematical underpinnings here:

\[
f(x) = \frac{e^{-(x - \mu)^{2}/(2\sigma^{2})}}{\sigma{\sqrt{2 \pi }}} 
\]

Instead, these notes (and the course) focus on how we get R to do the things we want to do, and how we interpret the results of our work. Our next Chapter provides a first example.

\hypertarget{part-part-a.-exploring-data}{%
\part*{Part A. Exploring Data}\label{part-part-a.-exploring-data}}
\addcontentsline{toc}{part}{Part A. Exploring Data}

\hypertarget{looking-at-the-palmer-penguins}{%
\chapter{Looking at the Palmer Penguins}\label{looking-at-the-palmer-penguins}}

The data in the \texttt{palmerpenguins} package in R include size measurements, clutch observations, and blood isotope ratios for adult foraging Adélie, Chinstrap, and Gentoo penguins observed on islands in the Palmer Archipelago near Palmer Station, Antarctica. The data were collected and made available by Dr.~Kristen Gorman and the Palmer Station Long Term Ecological Research (LTER) Program.

For more on the \texttt{palmerpenguins} package, visit \url{https://allisonhorst.github.io/palmerpenguins/}.

\hypertarget{package-loading-then-dealing-with-missing-data}{%
\section{Package Loading, then Dealing with Missing Data}\label{package-loading-then-dealing-with-missing-data}}

To start, let's load up the necessary R packages to manage the data and summarize it in a small table, and a plot. We've actually done this previously, but we'll repeat the steps here, because it's worth seeing what R is doing.

In this case, we'll load up five packages.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(palmerpenguins)  }\CommentTok{\# source for the data set}
\FunctionTok{library}\NormalTok{(janitor)         }\CommentTok{\# some utilities for cleanup and simple tables}
\FunctionTok{library}\NormalTok{(magrittr)        }\CommentTok{\# provides us with the pipe \%\textgreater{}\% for code management}
\FunctionTok{library}\NormalTok{(dplyr)           }\CommentTok{\# part of the tidyverse: data management tools}
\FunctionTok{library}\NormalTok{(ggplot2)         }\CommentTok{\# part of the tidyverse: tools for plotting data}
\end{Highlighting}
\end{Shaded}

It's worth remembering that everything after the \texttt{\#} on each line above is just a comment for the reader, and is ignored by R. We'll see later that the loading of a single package (called \texttt{tidyverse}) gives us both the \texttt{dplyr} and \texttt{ggplot2} packages, as well as several other useful things.

Next, let's take the \texttt{penguins} data from the \texttt{palmerpenguins} package, and identify those observations which have complete data (so, no missing values) in four variables of interest. We'll store that result in a new data frame (think of this as a data set) called \texttt{new\_penguins} and then take a look at that result using the following code.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{new\_penguins }\OtherTok{\textless{}{-}}\NormalTok{ penguins }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{filter}\NormalTok{(}\FunctionTok{complete.cases}\NormalTok{(flipper\_length\_mm, body\_mass\_g, species, sex))}

\NormalTok{new\_penguins}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 333 x 8
   species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g
   <fct>   <fct>              <dbl>         <dbl>             <int>       <int>
 1 Adelie  Torgersen           39.1          18.7               181        3750
 2 Adelie  Torgersen           39.5          17.4               186        3800
 3 Adelie  Torgersen           40.3          18                 195        3250
 4 Adelie  Torgersen           36.7          19.3               193        3450
 5 Adelie  Torgersen           39.3          20.6               190        3650
 6 Adelie  Torgersen           38.9          17.8               181        3625
 7 Adelie  Torgersen           39.2          19.6               195        4675
 8 Adelie  Torgersen           41.1          17.6               182        3200
 9 Adelie  Torgersen           38.6          21.2               191        3800
10 Adelie  Torgersen           34.6          21.1               198        4400
# ... with 323 more rows, and 2 more variables: sex <fct>, year <int>
\end{verbatim}

\hypertarget{counting-things-and-making-tables}{%
\section{Counting Things and Making Tables}\label{counting-things-and-making-tables}}

So, how many penguins are in our \texttt{new\_penguins} data? When we printed out the result, we got an answer, but (as with many things in R) there are many ways to get the same result.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nrow}\NormalTok{(new\_penguins)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 333
\end{verbatim}

How do our \texttt{new\_penguins} data break down by sex and species?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{new\_penguins }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{tabyl}\NormalTok{(sex, species) }\CommentTok{\# tabyl comes from the janitor package}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
    sex Adelie Chinstrap Gentoo
 female     73        34     58
   male     73        34     61
\end{verbatim}

Note the strange spelling of \texttt{tabyl} here. The output is reasonably clear, but could we make that table a little prettier, and while we're at it, can we add the row and column totals to it?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{new\_penguins }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{tabyl}\NormalTok{(sex, species) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{adorn\_totals}\NormalTok{(}\AttributeTok{where =} \FunctionTok{c}\NormalTok{(}\StringTok{"row"}\NormalTok{, }\StringTok{"col"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# add row, column totals}
\NormalTok{    kable  }\CommentTok{\# one convenient way to make the table prettier}
\end{Highlighting}
\end{Shaded}

\begin{tabular}{l|r|r|r|r}
\hline
sex & Adelie & Chinstrap & Gentoo & Total\\
\hline
female & 73 & 34 & 58 & 165\\
\hline
male & 73 & 34 & 61 & 168\\
\hline
Total & 146 & 68 & 119 & 333\\
\hline
\end{tabular}

\hypertarget{visualizing-the-data-in-a-graph-or-a-few}{%
\section{Visualizing the Data in a Graph (or a few\ldots)}\label{visualizing-the-data-in-a-graph-or-a-few}}

Now, let's look at the other two variables of interest. Let's create a graph showing the association of body mass with flipper length across the complete set of 333 penguins.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(new\_penguins, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ body\_mass\_g, }\AttributeTok{y =}\NormalTok{ flipper\_length\_mm)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{() }
\end{Highlighting}
\end{Shaded}

\includegraphics{431-notes_files/figure-latex/unnamed-chunk-5-1.pdf}

Some of you may want to include a straight-line model (fit by a classical linear regression) to this plot. One way to do that in R involves the addition of a single line of code, like this:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(new\_penguins, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ body\_mass\_g, }\AttributeTok{y =}\NormalTok{ flipper\_length\_mm)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x,}
                \AttributeTok{col =} \StringTok{"red"}\NormalTok{, }\AttributeTok{se =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{431-notes_files/figure-latex/unnamed-chunk-6-1.pdf}

Whenever we build a graph for ourselves, these default choices may be sufficient. But I'd like to see a prettier version if I was going to show it to someone else. So, I might use a different color for each species, and I might neaten up the theme (to get rid of the default grey background) and add a title, like this.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(new\_penguins, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ body\_mass\_g, }\AttributeTok{y =}\NormalTok{ flipper\_length\_mm, }\AttributeTok{col =}\NormalTok{ species)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
    \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+} 
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Flipper Length and Body Mass for 333 of the Palmer Penguins"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{431-notes_files/figure-latex/unnamed-chunk-7-1.pdf}

\hypertarget{six-ways-to-improve-this-graph}{%
\section{Six Ways To ``Improve'' This Graph}\label{six-ways-to-improve-this-graph}}

Now, let's build a new graph. Here, I want to:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  plot the relationship between body mass and flipper length in light of both Sex and Species
\item
  increase the size of the points and add a little transparency so we can see if points overlap,
\item
  add some smooth curves to summarize the relationships between the two quantities (body mass and flipper length) within each combination of species and sex,
\item
  split the graph into two ``facets'' (one for each sex),
\item
  improve the axis labels,
\item
  improve the titles by adding a subtitle, and also adding in some code to count the penguins (rather than hard-coding in the total number.)
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(new\_penguins, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ body\_mass\_g, }\AttributeTok{y =}\NormalTok{ flipper\_length\_mm, }
                         \AttributeTok{col =}\NormalTok{ species)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{size =} \DecValTok{2}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+} 
    \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"loess"}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x, }
                \AttributeTok{se =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{size =} \FloatTok{1.5}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{facet\_grid}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ sex) }\SpecialCharTok{+}
    \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+} 
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Flipper Length and Body Mass, by Sex \& Species"}\NormalTok{,}
         \AttributeTok{subtitle =} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(new\_penguins), }\StringTok{" of the Palmer Penguins"}\NormalTok{),}
         \AttributeTok{x =} \StringTok{"Body Mass (g)"}\NormalTok{, }
         \AttributeTok{y =} \StringTok{"Flipper Length (mm)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{431-notes_files/figure-latex/unnamed-chunk-8-1.pdf}

\hypertarget{a-little-reflection}{%
\section{A Little Reflection}\label{a-little-reflection}}

What can we learn from these plots and their construction? In particular,

\begin{itemize}
\tightlist
\item
  What do these plots suggest about the center of the distribution of each quantity (body mass and flipper length) overall, and within each combination of Sex and Species?
\item
  What does the final plot suggest about the spread of the distribution of each of those quantities in each combination of Sex and Species?
\item
  What do the plots suggest about the association of body mass and flipper length across the complete set of penguins?
\item
  How does the shape and nature of this body mass - flipper length relationship change based on Sex and Species?
\item
  Do you think it would be helpful to plot a straight-line relationship (rather than a smooth curve) within each combination of Sex and Species in the final plot? Why or why not? (Also, what would we have to do to the code to accomplish this?)
\item
  How was the R code for the plot revised to accomplish each of the six ``wants'' specified above?
\end{itemize}

\hypertarget{dataviz}{%
\chapter{NHANES: Initial Exploring}\label{dataviz}}

Next, we'll explore some data from the US National Health and Nutrition Examination Survey, or NHANES.

We'll display R code as we go, but we'll return to all of the key coding ideas involved later in the Notes.

\hypertarget{the-nhanes-data-a-first-sample}{%
\section{The NHANES data: A First Sample}\label{the-nhanes-data-a-first-sample}}

The \texttt{NHANES} package provides a sample of 10,000 NHANES responses from the 2009-10 and 2011-12 administrations, in a data frame also called \texttt{NHANES}. We can obtain the dimensions of this data frame (think of it as a rectangle of data) with the \texttt{dim()} function.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dim}\NormalTok{(NHANES)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 10000    76
\end{verbatim}

We see that we have 10000 rows and 76 columns in the \texttt{NHANES} data frame.

For the moment, let's gather a random sample of 1,000 responses from the 10000 rows listed in the \texttt{NHANES} data frame, and then identify several variables of interest about those subjects\footnote{For more on the NHANES data available in the NHANES package, type ?NHANES in the Console in R Studio.}. Some of the motivation for this example came from a Figure in \citet{BaumerKaplanHorton}.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# library(NHANES) \# already loaded NHANES package/library of functions, data}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{431001}\NormalTok{) }
\CommentTok{\# use set.seed to ensure that we all get the same random sample }
\CommentTok{\# of 1,000 NHANES subjects in our nh\_data collection}

\NormalTok{nh\_dat1 }\OtherTok{\textless{}{-}} 
    \FunctionTok{slice\_sample}\NormalTok{(NHANES, }\AttributeTok{n =} \DecValTok{1000}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{select}\NormalTok{(ID, SurveyYr, Gender, Age, Height)}

\NormalTok{nh\_dat1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1,000 x 5
      ID SurveyYr Gender   Age Height
   <int> <fct>    <fct>  <int>  <dbl>
 1 69638 2011_12  female     5   106.
 2 70782 2011_12  male      64   176.
 3 52408 2009_10  female    54   162.
 4 59031 2009_10  female    15   155.
 5 64530 2011_12  male      53   185.
 6 71040 2011_12  male      63   169.
 7 55186 2009_10  female    30   168.
 8 60211 2009_10  male       5   103.
 9 55730 2009_10  male      66   161.
10 68229 2011_12  female    36   170.
# ... with 990 more rows
\end{verbatim}

We have 1000 rows (observations) and 5 columns (variables) that describe the responses listed in the rows.

\hypertarget{age-and-height}{%
\section{Age and Height}\label{age-and-height}}

Suppose we want to visualize the relationship of Height and Age in our 1,000 NHANES observations. The best choice is likely to be a scatterplot.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ nh\_dat1, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Age, }\AttributeTok{y =}\NormalTok{ Height)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Warning: Removed 37 rows containing missing values (geom_point).
\end{verbatim}

\includegraphics{431-notes_files/figure-latex/nh_dat1_heightbyage1-fig-1.pdf}

We note several interesting results here.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  As a warning, R tells us that it has ``Removed 37 rows containing missing values (geom\_point).'' Only 963 subjects plotted here, because the remaining 37 people have missing (NA) values for either Height, Age or both.
\item
  Unsurprisingly, the measured Heights of subjects grow from Age 0 to Age 20 or so, and we see that a typical Height increases rapidly across these Ages. The middle of the distribution at later Ages is pretty consistent at at a Height somewhere between 150 and 175. The units aren't specified, but we expect they must be centimeters. The Ages are clearly reported in Years.
\item
  No Age is reported over 80, and it appears that there is a large cluster of Ages at 80. This may be due to a requirement that Ages 80 and above be reported at 80 so as to help mask the identity of those individuals.\footnote{If you visit the NHANES help file with ?NHANES, you will see that subjects 80 years or older were indeed recorded as 80.}
\end{enumerate}

As in this case, we're going to build most of our visualizations using tools from the \texttt{ggplot2} package, which is part of the \texttt{tidyverse} series of packages. You'll see similar coding structures throughout this Chapter, most of which are covered as well in Chapter 3 of \citet{R4DS}.

\hypertarget{subset-of-subjects-with-known-age-and-height}{%
\section{Subset of Subjects with Known Age and Height}\label{subset-of-subjects-with-known-age-and-height}}

Before we move on, let's manipulate the data set a bit, to focus on only those subjects who have complete data on both Age and Height. This will help us avoid that warning message.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nh\_dat2 }\OtherTok{\textless{}{-}}\NormalTok{ nh\_dat1 }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{filter}\NormalTok{(}\FunctionTok{complete.cases}\NormalTok{(Age, Height)) }

\FunctionTok{summary}\NormalTok{(nh\_dat2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
       ID           SurveyYr      Gender         Age            Height     
 Min.   :51624   2009_10:487   female:484   Min.   : 2.00   Min.   : 85.0  
 1st Qu.:57034   2011_12:476   male  :479   1st Qu.:19.00   1st Qu.:156.2  
 Median :62056                              Median :37.00   Median :165.0  
 Mean   :61967                              Mean   :38.29   Mean   :162.3  
 3rd Qu.:67269                              3rd Qu.:56.00   3rd Qu.:174.5  
 Max.   :71875                              Max.   :80.00   Max.   :195.9  
\end{verbatim}

Note that the units and explanations for these variables are contained in the NHANES help file, available via typing \texttt{?NHANES} in the Console of R Studio, or by typing \texttt{NHANES} into the Search bar in R Studio's Help window.

\hypertarget{the-distinction-between-gender-and-sex}{%
\subsection{\texorpdfstring{The Distinction between \texttt{Gender} and \texttt{Sex}}{The Distinction between Gender and Sex}}\label{the-distinction-between-gender-and-sex}}

The \texttt{Gender} variable here is mis-named. These data refer to the biological status of these subjects, which is their \texttt{Sex}, and not the social construct of \texttt{Gender} which can be quite different. In our effort to avoid further confusion, we'll rename the variable \texttt{Gender} to \texttt{Sex} so as to more accurately describe what is actually measured here.

To do this, we can use this approach\ldots{}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nh\_dat2 }\OtherTok{\textless{}{-}}\NormalTok{ nh\_dat1 }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{rename}\NormalTok{(}\AttributeTok{Sex =}\NormalTok{ Gender) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{filter}\NormalTok{(}\FunctionTok{complete.cases}\NormalTok{(Age, Height)) }

\FunctionTok{summary}\NormalTok{(nh\_dat2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
       ID           SurveyYr       Sex           Age            Height     
 Min.   :51624   2009_10:487   female:484   Min.   : 2.00   Min.   : 85.0  
 1st Qu.:57034   2011_12:476   male  :479   1st Qu.:19.00   1st Qu.:156.2  
 Median :62056                              Median :37.00   Median :165.0  
 Mean   :61967                              Mean   :38.29   Mean   :162.3  
 3rd Qu.:67269                              3rd Qu.:56.00   3rd Qu.:174.5  
 Max.   :71875                              Max.   :80.00   Max.   :195.9  
\end{verbatim}

That's better. How many observations do we have now? We could use \texttt{dim} to find out the number of rows and columns in this new data set.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dim}\NormalTok{(nh\_dat2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 963   5
\end{verbatim}

Or, we could simply list the data set and read off the result.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nh\_dat2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 963 x 5
      ID SurveyYr Sex      Age Height
   <int> <fct>    <fct>  <int>  <dbl>
 1 69638 2011_12  female     5   106.
 2 70782 2011_12  male      64   176.
 3 52408 2009_10  female    54   162.
 4 59031 2009_10  female    15   155.
 5 64530 2011_12  male      53   185.
 6 71040 2011_12  male      63   169.
 7 55186 2009_10  female    30   168.
 8 60211 2009_10  male       5   103.
 9 55730 2009_10  male      66   161.
10 68229 2011_12  female    36   170.
# ... with 953 more rows
\end{verbatim}

\hypertarget{age-height-and-sex}{%
\section{Age-Height and Sex?}\label{age-height-and-sex}}

Let's add Sex to the plot using color, and also adjust the y axis label to incorporate the units of measurement.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ nh\_dat2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Age, }\AttributeTok{y =}\NormalTok{ Height, }\AttributeTok{color =}\NormalTok{ Sex)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Height{-}Age Relationship in NHANES sample"}\NormalTok{, }
         \AttributeTok{y =} \StringTok{"Height in cm."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{431-notes_files/figure-latex/nh_dat2_heightbyageandsex1-fig-1.pdf}

\hypertarget{can-we-show-the-female-and-male-relationships-in-separate-panels}{%
\subsection{Can we show the Female and Male relationships in separate panels?}\label{can-we-show-the-female-and-male-relationships-in-separate-panels}}

Sure.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ nh\_dat2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Age, }\AttributeTok{y =}\NormalTok{ Height, }\AttributeTok{color =}\NormalTok{ Sex)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Height{-}Age Relationship in NHANES sample"}\NormalTok{, }
         \AttributeTok{y =} \StringTok{"Height in cm."}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ Sex)}
\end{Highlighting}
\end{Shaded}

\includegraphics{431-notes_files/figure-latex/nh_dat2_heightbyageandsex2-fig-1.pdf}

\hypertarget{can-we-add-a-smooth-curve-to-show-the-relationship-in-each-plot}{%
\subsection{Can we add a smooth curve to show the relationship in each plot?}\label{can-we-add-a-smooth-curve-to-show-the-relationship-in-each-plot}}

Yep, and let's change the theme of the graph to remove the gray background, too.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ nh\_dat2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Age, }\AttributeTok{y =}\NormalTok{ Height, }\AttributeTok{color =}\NormalTok{ Sex)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
    \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"loess"}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x) }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Height{-}Age Relationship in NHANES sample"}\NormalTok{, }
         \AttributeTok{y =} \StringTok{"Height in cm."}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ Sex)}
\end{Highlighting}
\end{Shaded}

\includegraphics{431-notes_files/figure-latex/nh_dat2_heightbyageandsex3-fig-1.pdf}

\hypertarget{what-if-we-want-to-assume-straight-line-relationships}{%
\subsection{What if we want to assume straight line relationships?}\label{what-if-we-want-to-assume-straight-line-relationships}}

We could look at a linear model in the plot. Does this make sense here?

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ nh\_dat2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ Age, }\AttributeTok{y =}\NormalTok{ Height, }\AttributeTok{color =}\NormalTok{ Sex)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
    \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x) }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Height{-}Age Relationship in NHANES sample"}\NormalTok{, }
         \AttributeTok{y =} \StringTok{"Height in cm."}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ Sex)}
\end{Highlighting}
\end{Shaded}

\includegraphics{431-notes_files/figure-latex/nh_dat2_heightbyageandsex4-fig-1.pdf}

I hope it seems clear from the graphs that a more complex relationship is going on here than just a straight line.

In the next Section of these Notes, we'll take a more carefully selected sample of NHANES respondents, and study those subjects in greater detail.

  \bibliography{book.bib,packages.bib}

\end{document}
